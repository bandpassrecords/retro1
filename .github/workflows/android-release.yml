name: Android Release Build

# PERMISSÃO: Necessária para que a ação 'upload-release-asset' funcione.
permissions:
  contents: write 

# 1. Gatilhos do Workflow
on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

  push:
    branches: [ main ]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

# Variáveis de Configuração
env:
  FLUTTER_BASE_VERSION: 3.24.x 

# 2. Jobs
jobs:
  # Job de Teste de Integração (para Pull Requests)
  test_pr_build:
    name: Test PR Build (Android)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter ${{ env.FLUTTER_BASE_VERSION }} (Stable)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_BASE_VERSION }}
          channel: 'stable' 

      - name: Run Flutter Upgrade
        run: flutter upgrade

      - name: Get dependencies
        run: flutter pub get

      # Generate localization files
      - name: Generate Localizations
        run: flutter gen-l10n

      # Generate code with build_runner
      - name: Generate Hive Adapters
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Test (Debug APK)
        run: flutter build apk --debug
        continue-on-error: true

      - name: Upload APK artifacts (PR Test)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-pr-test
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 7
          if-no-files-found: ignore
        continue-on-error: true

  # Android Build Job (for both PRs and Releases)
  build-android:
    name: Build Android (${{ github.event_name == 'pull_request' && 'PR Test' || 'Release' }})
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter ${{ env.FLUTTER_BASE_VERSION }} (Stable)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_BASE_VERSION }}
          channel: 'stable'

      - name: Run Flutter Upgrade
        run: flutter upgrade

      - name: Get dependencies
        run: flutter pub get

      - name: Setup Android Keystore (Release only)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Create keystore directory if it doesn't exist
          mkdir -p android/app
          
          # Decode and save keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
          
          # Verify keystore was created
          if [ ! -f android/app/release.keystore ]; then
            echo "ERROR: Keystore file was not created!"
            exit 1
          fi
          
          # Create key.properties file
          mkdir -p android
          cat > android/key.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF
          
          # Verify key.properties was created
          if [ ! -f android/key.properties ]; then
            echo "ERROR: key.properties file was not created!"
            exit 1
          fi
          
          echo "Keystore setup completed successfully"
          echo "Keystore file exists: $(test -f android/app/release.keystore && echo 'YES' || echo 'NO')"
          echo "key.properties exists: $(test -f android/key.properties && echo 'YES' || echo 'NO')"
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Determine version from tag (Release only)
        if: startsWith(github.ref, 'refs/tags/v')
        id: version
        run: |
          # Extract version from tag (e.g., v1.7.0 -> 1.7.0)
          TAG_NAME=${GITHUB_REF#refs/tags/v}
          echo "version_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          # Extract version code from tag (e.g., 1.7.0 -> 170)
          VERSION_CODE=$(echo ${TAG_NAME} | tr -d '.' | cut -c1-9)
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT

      - name: Update version in pubspec.yaml (Release only)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION_NAME="${{ steps.version.outputs.version_name }}"
          VERSION_CODE="${{ steps.version.outputs.version_code }}"
          
          # Update version in pubspec.yaml
          sed -i "s/^version: .*/version: $VERSION_NAME+$VERSION_CODE/" pubspec.yaml
          
          echo "Updated pubspec.yaml to version: $VERSION_NAME+$VERSION_CODE"

      - name: Generate Localizations
        run: flutter gen-l10n

      - name: Generate Hive Adapters
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Verify Keystore Configuration (Release only)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "Verifying keystore configuration..."
          if [ ! -f android/key.properties ]; then
            echo "ERROR: android/key.properties not found!"
            exit 1
          fi
          if [ ! -f android/app/release.keystore ]; then
            echo "ERROR: android/app/release.keystore not found!"
            exit 1
          fi
          echo "✓ Keystore files found"
          echo "Key.properties contents (without passwords):"
          grep -v "Password" android/key.properties || true

      - name: Build Android App Bundle (AAB) - Release
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          flutter build appbundle --release
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Verify AAB Signature (Release only)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          AAB_PATH="build/app/outputs/bundle/release/app-release.aab"
          if [ ! -f "$AAB_PATH" ]; then
            echo "ERROR: AAB file not found at $AAB_PATH"
            exit 1
          fi
          
          echo "Verifying AAB signature..."
          # Use jarsigner to verify the signature
          jarsigner -verify -verbose -certs "$AAB_PATH" || {
            echo "ERROR: AAB signature verification failed!"
            exit 1
          }
          echo "✓ AAB is properly signed"

      - name: Build Android APK - PR Test (unsigned)
        if: github.event_name == 'pull_request'
        run: |
          flutter build apk --debug
        continue-on-error: true

      - name: Build Android APK - Release (for testing)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          flutter build apk --release --split-per-abi
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        continue-on-error: true

      - name: Find Existing Release URL
        if: startsWith(github.ref, 'refs/tags/v')
        id: find_release
        uses: actions/github-script@v6
        env:
          RELEASE_TAG: ${{ github.ref_name }}
        with:
          script: |
            try {
              const { data: release } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: process.env.RELEASE_TAG,
              });
              core.setOutput('upload_url', release.upload_url);
              console.log(`Found Release URL: ${release.upload_url}`);
            } catch (error) {
              core.setFailed(`Release with tag ${process.env.RELEASE_TAG} not found. Please create a Release manually on GitHub matching this tag before pushing the tag.`);
            }

      - name: Upload AAB to Release
        if: startsWith(github.ref, 'refs/tags/v') && steps.find_release.outputs.upload_url != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.find_release.outputs.upload_url }}
          asset_path: build/app/outputs/bundle/release/app-release.aab
          asset_name: Retro1_Android_${{ github.ref_name }}.aab
          asset_content_type: application/vnd.android.package-archive

      - name: Upload APK artifacts (PR)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-pr-test
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 7
          if-no-files-found: ignore
        continue-on-error: true

      - name: Upload APK artifacts (Release - for testing)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 90
          if-no-files-found: ignore
        continue-on-error: true

      - name: Create Release Summary
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "## Android Release Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version Name:** ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version Code:** ${{ steps.version.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **AAB (App Bundle):** Uploaded to Release (required for Google Play Store)" >> $GITHUB_STEP_SUMMARY
          echo "- **APKs:** Available as artifacts (for testing)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the AAB from the Release page" >> $GITHUB_STEP_SUMMARY
          echo "2. Upload to Google Play Console" >> $GITHUB_STEP_SUMMARY
          echo "3. Complete the release process in Play Console" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Note on Play App Signing" >> $GITHUB_STEP_SUMMARY
          echo "This AAB is signed with your **upload key**. Google Play will re-sign it with the app signing key (managed by Google via Play App Signing) before distribution to users." >> $GITHUB_STEP_SUMMARY

      - name: Create PR Test Summary
        if: github.event_name == 'pull_request'
        run: |
          echo "## Android PR Build Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Android build completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** Debug (unsigned, for testing only)" >> $GITHUB_STEP_SUMMARY
          echo "- **APK:** Available as artifact (for testing)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Note" >> $GITHUB_STEP_SUMMARY
          echo "This is an unsigned debug build for PR validation. Release builds with signing are only created for tagged releases." >> $GITHUB_STEP_SUMMARY
